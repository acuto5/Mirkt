<?php

namespace Tests\Feature\Controllers\Tags;

use App\Tag;
use App\User;
use Illuminate\Database\Eloquent\Collection;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Pagination\LengthAwarePaginator;
use Illuminate\Support\Facades\Auth;
use Tests\TestCase;

class TagsControllerTest extends TestCase
{
    use RefreshDatabase;

    /**
     * @var Collection
     */
    private $tags;

    /**
     * @var User
     */
    private $simpleUser;

    /**
     * @var User
     */
    private $moderatorUser;

    /**
     * @var string
     */
    private $getAllTagsRoute;

    /**
     * @var string
     */
    private $indexRoute;

    /**
     * @var int
     */
    private $tagsPerPage;

    /**
     * @var string
     */
    private $storeRoute;

    /**
     * @var string
     */
    private $updateRoute;

    /**
     * @var string
     */
    private $deleteRoute;

    /**
     * Set up
     */
    public function setUp(): void
    {
        parent::setUp(); // TODO: Change the autogenerated stub

        $this->tagsPerPage = 10;
        $this->indexRoute = route('getTags');
        $this->storeRoute = route('storeTag');
        $this->updateRoute = route('updateTag');
        $this->deleteRoute = route('destroyTag');
        $this->tags = factory(Tag::class, 15)->create();
        $this->simpleUser = factory(User::class)->create();
        $this->getAllTagsRoute = route('getAllTags');
        $this->adminUser = factory(User::class)->states('admin')->create();
        $this->moderatorUser = factory(User::class)->states('moderator')->create();
        $this->superAdminUser = factory(User::class)->states('superAdmin')->create();
    }

    /**
     * Test get all tags
     */
    public function testGetAll(): void
    {
        /**
         * Params for request
         */
        $requestParams = ['get', $this->getAllTagsRoute];

        /**
         * Check is method protected and available user with moderator role
         */
        $this->checkIsUserHasAtLeastModeratorRole(...$requestParams);

        /**
         * Login user as moderator
         */
        Auth::login($this->moderatorUser);

        /**
         * Make new request
         */
        $response = $this->json(...$requestParams);

        /**
         * Check is response is same as expected
         */
        $response->assertExactJson($this->tags->toArray());
    }

    /**
     * Test index
     */
    public function testIndex(): void
    {
        /**
         * Request params
         */
        $requestParams = ['get', $this->indexRoute];

        /**
         * Check is method protected and available user with moderator role
         */
        $this->checkIsUserHasAtLeastModeratorRole(...$requestParams);

        /**
         * Login user as moderator
         */
        Auth::login($this->moderatorUser);

        /**
         * Make request
         */
        $response = $this->json(...$requestParams);

        /**
         * Check is request was successful
         */
        $response->assertSuccessful();

        /**
         * Make paginator
         */
        $tagsPaginator = new LengthAwarePaginator(
            $this->tags->take($this->tagsPerPage),
            $this->tags->count(),
            $this->tagsPerPage
        );

        /**
         * Check is same response as expected
         */
        $response->assertExactJson($tagsPaginator->setPath($this->indexRoute)->toArray());

        /**
         * Search result is not tested, because results can be to different.
         * Create tags very different, if you want test search results.
         */
    }

    /**
     * Test store tag
     */
    public function testStoreTag()
    {
        /**
         * Request params
         */
        $requestParams = ['post', $this->storeRoute, ['name' => 'storeTagTest']];

        /**
         * Check is method protected and available user with moderator role
         */
        $this->checkIsUserHasAtLeastModeratorRole(...$requestParams);

        /**
         * Login user as Moderator
         */
        Auth::login($this->moderatorUser);

        /**
         * Make request
         */
        $response = $this->json(...$requestParams);

        /**
         * Check is request is successful
         */
        $response->assertSuccessful();
    }

    /**
     * Test update tag
     */
    public function testUpdateTag()
    {
        /**
         * Request params
         */
        $requestParams = ['patch', $this->updateRoute, ['id' => $this->tags->first()->id, 'name' => 'updateTagTest']];

        /**
         * Check is method protected and available user with moderator role
         */
        $this->checkIsUserHasAtLeastModeratorRole(...$requestParams);

        /**
         * Login user as moderator
         */
        Auth::login($this->moderatorUser);

        /**
         * Make request
         */
        $response = $this->json(...$requestParams);

        /**
         * Check status
         */
        $response->assertSuccessful();

        /**
         * Check if tag is changed correctly
         */
        $this->assertEquals($requestParams[2], Tag::first()->toArray());
    }

    public function testDestroyTag()
    {
        /**
         * Check is method protected and available user with moderator role
         */
        $this->checkIsUserHasAtLeastModeratorRole('delete', $this->deleteRoute, ['id' => Tag::first()->id]);

        /**
         * Login user as moderator
         */
        Auth::login($this->moderatorUser);

        /**
         * Make request
         */
        $response = $this->json('delete', $this->deleteRoute, ['id' => Tag::first()->id]);

        /**
         * Check is request has successful
         */
        $response->assertSuccessful();
    }

    //---------------------------------
    // Private
    //---------------------------------

    /**
     * Check is method protected and available user with moderator role
     *
     * @param string $method
     * @param string $route
     * @param array $data
     */
    private function checkIsUserHasAtLeastModeratorRole(string $method, string $route, array $data = []): void
    {
        $this->checkIsGuestGetUnauthorizedResponse($method, $route, $data);
        $this->checkIsSimpleUserUnauthorizedResponse($method, $route, $data);
        $this->checkIsModeratorCanMakeRequest($method, $route, $data);
    }

    /**
     * Check is guest get unauthorized response
     *
     * @param string $method
     * @param string $route
     * @param array $data
     */
    private function checkIsGuestGetUnauthorizedResponse(string $method, string $route, array $data = []): void
    {
        /**
         * Check is no one is logged in
         */
        $this->assertGuest();

        /**
         * Make unauthorized request
         */
        $response = $this->json($method, $route, $data);

        /**
         * Check if request is denied
         */
        $response->assertStatus(401);
    }

    /**
     * Check is simple user unauthorized response
     *
     * @param string $method
     * @param string $route
     * @param array $data
     */
    private function checkIsSimpleUserUnauthorizedResponse(string $method, string $route, array $data = []): void
    {
        /**
         * Make request as simple user
         */
        Auth::login($this->simpleUser);

        /**
         * Check is user logged in
         */
        $this->assertAuthenticatedAs($this->simpleUser);

        /**
         * Make request
         */
        $response = $this->json($method, $route, $data);

        /**
         * Check if request is denied
         */
        $response->assertStatus(401);

        /**
         * Check is error code is the same
         */
        $response->assertExactJson(['message' => 'You don\'t have moderator role.']);

        /**
         * Logout user
         */
        Auth::logout();
    }

    /**
     * @param string $method
     * @param string $route
     * @param array $data
     */
    private function checkIsModeratorCanMakeRequest(string $method, string $route, array $data = []): void
    {
        /**
         * Make request as simple user
         */
        Auth::login($this->moderatorUser);

        /**
         * Check is user logged in
         */
        $this->assertAuthenticatedAs($this->moderatorUser);

        /**
         * Make request
         */
        $response = $this->json($method, $route, $data);

        /**
         * Check if request is denied
         */
        $response->assertStatus(200);

        /**
         * Logout user
         */
        Auth::logout();
    }
}
